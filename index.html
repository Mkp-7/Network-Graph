<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Network Graph with Popup</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      height: 100%;
    }

    #graph-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    #popup {
      position: fixed;
      top: 20px;
      left: 20px;
      background: black;
      border: 2px solid red;
      border-radius: 8px;
      color: white;
      padding: 12px;
      max-width: 320px;
      font-size: 14px;
      display: none;
      z-index: 9999;
    }

    #popup h3 {
      margin: 0 0 6px 0;
      color: red;
      font-size: 16px;
      border-bottom: 1px solid red;
      padding-bottom: 4px;
    }

    #popup ul {
      margin: 5px 0 0 15px;
      padding: 0;
      list-style-type: disc;
      max-height: 200px;
      overflow-y: auto;
    }

    #popup button {
      margin-top: 10px;
      padding: 5px 10px;
      background: red;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #legend {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 9999;
    }

    .legend-color {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>

<div id="graph-container"></div>

<div id="popup">
  <h3 id="popup-title"></h3>
  <div id="popup-content"></div>
  <button onclick="popup.style.display='none'">Close</button>
</div>

<div id="legend">
  <div><span class="legend-color" style="background:#FF6600;"></span> Campus Partner</div>
  <div><span class="legend-color" style="background:#0099CC;"></span> Community Org</div>
  <div><span class="legend-color" style="background:#990000;"></span> Activity</div>
</div>

<script src="https://unpkg.com/three@0.137.5/build/three.min.js"></script>
<script src="https://unpkg.com/3d-force-graph"></script>
<script>
  const popup = document.getElementById('popup');
  const popupTitle = document.getElementById('popup-title');
  const popupContent = document.getElementById('popup-content');

  fetch('data.json')
    .then(res => res.json())
    .then(data => {
      const nodesMap = {}, links = [], nodeLinks = {};

      data.forEach(row => {
        const activity = row.activity_name?.trim();
        if (!activity) return;

        if (!nodesMap[activity]) nodesMap[activity] = { id: activity, group: 'activity' };

        const campusList = row.campus_partners ? row.campus_partners.split(',').map(x => x.trim()) : [];
        const communityList = row.community_organizations ? row.community_organizations.split(',').map(x => x.trim()) : [];

        campusList.forEach(partner => {
          if (!nodesMap[partner]) nodesMap[partner] = { id: partner, group: 'campus', count: 0 };
          nodesMap[partner].count++;
          links.push({ source: partner, target: activity });
          nodeLinks[partner] = (nodeLinks[partner] || []).concat(activity);
        });

        communityList.forEach(org => {
          if (!nodesMap[org]) nodesMap[org] = { id: org, group: 'community', count: 0 };
          nodesMap[org].count++;
          links.push({ source: org, target: activity });
          nodeLinks[org] = (nodeLinks[org] || []).concat(activity);
        });
      });

      const nodes = Object.values(nodesMap);

      const Graph = ForceGraph3D()(document.getElementById('graph-container'))
        .graphData({ nodes, links })
        .nodeRelSize(6)
        .nodeThreeObject(node => {
          const size = 5 + (node.count || 1) * 1.2;
          const geometry = new THREE.SphereGeometry(size, 16, 16);
          const color = node.group === 'campus' ? 0xFF6600 :
                        node.group === 'community' ? 0x0099CC : 0x990000;
          const material = new THREE.MeshPhongMaterial({ color });
          return new THREE.Mesh(geometry, material);
        })
        .linkWidth(3)
        .linkColor(() => '#00008B')
        .backgroundColor('#ffffff')
        .onNodeClick(node => {
          if (node.group === 'activity') return;
          const related = nodeLinks[node.id] || [];
          const html = related.length
            ? '<ul>' + [...new Set(related)].map(a => `<li>${a}</li>`).join('') + '</ul>'
            : '<i>No connected activities</i>';
          popupTitle.textContent = `${node.id} (${node.group === 'campus' ? 'Campus Partner' : 'Community Organization'})`;
          popupContent.innerHTML = html;
          popup.style.display = 'block';
        })
        .onBackgroundClick(() => popup.style.display = 'none');

      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      const directional = new THREE.DirectionalLight(0xffffff, 0.8);
      directional.position.set(1, 1, 1);

      Graph.scene().add(ambient);
      Graph.scene().add(directional);
    })
    .catch(err => {
      document.body.innerHTML = `<h2 style="color:red;">Failed to load data.json</h2><p>${err}</p>`;
    });
</script>
</body>
</html>
